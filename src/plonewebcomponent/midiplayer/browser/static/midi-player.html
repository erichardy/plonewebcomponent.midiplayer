<!--
A WEB component that provides MIDI file playback.

@element midi-player
@homepage https://github.com/miztroh/midi-player
-->
<template id="play-midi">
    <style>
       .hidden {
        display: none;
       }
       .shown {
        display: block;
        }
	</style>

  <button id="start" onclick="startPlaying(); return false;">start</button>
  <button id="pause" onclick="pausePlaying()">Pause</button>
  <button id="resume" onclick="resumePlaying()">resume</button>
  <button id="stop" onclick="stopPlaying()">stop</button>
</template>
<script>
    function stopPlaying() {
        player.stop();
    };
    function pausePlaying() {
    	player.pause();
    	
    }
    function startPlaying() {
    	player.start();
    	// template.getElementById("#start").className = 'hidden';
    	$(":host::shadow #start").css("display", "none");
    	console.log($(":host::shadow #start"));
    }
    function resumePlaying() {
    	player.resume();
    }
	function loadSoundFont(SFlocation, instrument) {
		// location = portal_url + "/++plone++midiplayer/soundfont/"
		// instrument = "acoustic_grand_piano"
		MIDI.loadPlugin(
				{
				    soundfontUrl: SFlocation,
				    instrument: "acoustic_grand_piano",
				    onprogress: function(state, progress) {
			            // MIDI.loader.setValue(progress * 100);
			            // console.log(state, progress);
			        },
				    callback: function () {}
				});
	};
	var player = MIDI.Player ;
	player.addListener(function(data){
		// console.log(data.now);
		$("#now").html(data.now);
	});
	
	var midiPlayerDoc = document.currentScript.ownerDocument;
	var template = midiPlayerDoc.querySelector('#play-midi');
	var midiPlayer = document.registerElement('play-midi', {
		prototype: Object.create(HTMLElement.prototype, {
			 createdCallback: {
				  value: function() {
					  var root = this.createShadowRoot();
					  // var template = midiPlayerDoc.querySelector('#play-midi');
					  var clone = document.importNode(template.content, true);
					  var SFlocation = this.getAttribute("SFlocation");
					  var instrument = this.getAttribute("instrument");
					  var autoplay = this.getAttribute("autoplay");
					  loadSoundFont(SFlocation, instrument);
					  
					  var src = this.getAttribute("src");
					  var autoplay = this.getAttribute("autoplay");
					  // console.log(SFlocation);
					  // console.log(instrument);
					  // console.log(src);
					  
					  player.timeWarp = 1;
					  if (autoplay === "1") {
					      player.loadFile(src, player.start);
					  }
					  else {
						  player.loadFile(src);
					  }
					  root.appendChild(clone);
					}
				 }
			 })
	});

</script>
