<!--
A WEB component that provides MIDI file playback.

@element midi-player
@homepage https://github.com/miztroh/midi-player
-->
<template id="midi-player">
    <style>
       .hidden {
        display: none;
       }
       .shown {
        display: block;
        }
	</style>

  <button id="start" onclick="startPlaying(this); return false;">start</button>
  <button id="pause" onclick="pausePlaying(this)">Pause</button>
  <button id="resume" onclick="resumePlaying()">resume</button>
  <button id="stop" onclick="stopPlaying()">stop</button>
</template>
<script>
    function stopPlaying() {
        player.stop();
    };
    function pausePlaying(tmpl) {
    	player.pause();
    	console.log(tmpl);
    }
    function startPlaying(tmpl) {
    	player.start();
    	// template.getElementById("#start").className = 'hidden';
    	console.log(tmpl);
    	// $(":host::shadow #start").css("display", "none");
    	// console.log($(":host::shadow #start"));
    }
    function resumePlaying() {
    	player.resume();
    }
	function loadSoundFont(SFlocation, instrument) {
		// location = portal_url + "/++plone++midiplayer/soundfont/"
		// instrument = "acoustic_grand_piano"
		MIDI.loadPlugin(
				{
				    soundfontUrl: SFlocation,
				    instrument: "acoustic_grand_piano",
				    onprogress: function(state, progress) {
			            // MIDI.loader.setValue(progress * 100);
			            // console.log(state, progress);
			        },
				    callback: function () {}
				});
	};
	var player = MIDI.Player ;
	
	
	var midiPlayerDoc = document.currentScript.ownerDocument;
	var template = midiPlayerDoc.querySelector('#midi-player');
	var midiPlayer = document.registerElement('play-midi', {
		prototype: Object.create(HTMLElement.prototype, {
			 createdCallback: {
				  value: function() {
					  var root = this.createShadowRoot();
					  console.log(this);
					  // var template = midiPlayerDoc.querySelector('#play-midi');
					  var clone = document.importNode(template.content, true);
					  var SFlocation = this.getAttribute("SFlocation");
					  var instrument = this.getAttribute("instrument");
					  var autoplay = this.getAttribute("autoplay");
					  loadSoundFont(SFlocation, instrument);
					  
					  var src = this.getAttribute("src");
					  var autoplay = this.getAttribute("autoplay");
					  // console.log(SFlocation);
					  // console.log(instrument);
					  // console.log(src);
					  
					  player.timeWarp = 1;
					  if (autoplay === "1") {
					      player.loadFile(src, player.start);
					  }
					  else {
						  player.loadFile(src);
					  }
					  root.appendChild(clone);
					  console.log(root.querySelector("#start"));
					  start = root.querySelector("#start");
					  $(start).css("display", "inline");
					  player.addListener(function(data){
		                  if (player.playing) {$(start).css("display", "none");}
		                  else {$(start).css("display", "inline");}
						    // console.log('-----');
		                    // console.log(root);
		                    // $("#now").html(data.now);
		                });
				  
				  }
				 }
			 })
			 
	
	
	});
	

</script>
